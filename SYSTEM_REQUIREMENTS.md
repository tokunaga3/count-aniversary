# システム要件定義（Count Anniversary）

最終更新日: 2025-10-15

## 1. 概要
- 本システムは、ユーザーが指定した記念日を起点に、月単位で一定期間（年数指定）の予定を Google カレンダーへ自動登録する Web アプリケーションである。
- 対象: 個人〜小規模チーム（家族やカップル、グループでの記念日管理）
- 目的: 記念日イベントの一括生成と登録作業の簡素化、進捗の可視化

## 2. スコープ
- Google アカウントによるログイン（NextAuth + Google Provider）
- Google カレンダーへのイベント登録（OAuth2）
- 任意の開始日と「何年分」かの期間指定に基づく月次イベントの生成
- UI からの手動停止、進捗・残件数の表示
- 許可ユーザー制限（Google スプレッドシートの許可リストによるアクセス制御、機能トグルで切替可能）
// NEW
- 法要（日数/年数マイルストーン）自動生成（命日→初七日〜五十回忌）
- 隔週スケジューリング（曜日と時間帯指定、日本の祝日除外対応）

## 3. 用語定義
- 記念日: ユーザーが起点として指定する日付（例: 結婚記念日）
- 記録年数: 記念日から何年分のイベントを作成するか（1〜100年）
- 許可ユーザー制限: スプレッドシートのリストに存在するメールアドレスのみログインを許可する仕組み

## 4. 前提・制約
- 対応ブラウザ: 最新版の Chrome/Edge/Safari
- Google API クォータ: レート制限遵守のため逐次登録と軽微な遅延を挿入
- 最大期間: 100年（50年以上は警告表示）
- 認証: NextAuth v5系（App Router）
- フロント: Next.js 15 + TypeScript + Tailwind CSS

## 5. ユースケース
1) 記念日と「何年分」を入力し、タイトル/メモを設定して登録する
2) 進捗を監視し、必要に応じて登録を停止する
3) 許可ユーザーリスト外のユーザーはログインを拒否される（機能有効時）

## 6. 機能要件
### 6.1 認証・認可
- Google アカウントでログインできること
- 許可ユーザー制限フラグ `IS_ALLOWED_GOOGLE_AUTH_ENABLED` が `true` の場合:
  - スプレッドシート `ALLOWED_USERS_SPREADSHEET_ID` の `ALLOWED_USERS_RANGE` に存在するメールのみログイン許可
  - スプレッドシート取得エラーや環境変数未設定時はログイン拒否
- フラグが `false`（または未設定）の場合:
  - 許可ユーザー制限をスキップし、Google サインイン成功者を許可

### 6.2 記念日イベント生成
- 入力:
  - 記念日（yyyy-mm-dd）
  - 記録年数（1〜100, 既定 10）
  - カレンダーID（登録先）
  - タイトル（テンプレートサポート: `{{ym}}`, `{{years}}`, `{{months}}`, `{{count}}`）
  - メモ（任意）
- 出力: 記念日の月次イベント群（合計: 記録年数×12件 目安）
- 仕様:
  - 生成 API: `/api/anniversary?action=generate`（開始日/終了日/タイトル/メモ）
  - 登録 API: `/api/anniversary`（`create-single`を逐次呼び出し）
  - レート制限対策: 1件毎に短い待機を挿入
  - 進捗更新: 現在件数/総件数/対象日付/サマリ/残数

### 6.3 進捗・停止
- 進捗オーバーレイでパーセンテージ、段階、詳細を表示
- 停止ボタンで現在の処理を中断（AbortController と EventSource 管理）
- 停止時は完了件数と未処理件数を表示

### 6.4 UI/UX
- 記念日名テンプレートのクイック挿入ボタン
- 入力バリデーション:
  - 記録年数: 1未満エラー、>100エラー、≥50は警告
  - 必須: 記念日, カレンダーID
- 進捗詳細に「記録期間: n年分 (〜yyyy/mm/dd)」を表示

### 6.5 法要自動生成（NEW）
- 入力:
  - 命日（yyyy-mm-dd）
  - カレンダーID
  - タイトルテンプレート（プレースホルダー対応: `{{houyou}}`, `{{year}}`, `{{base_date}}`）
  - メモ（任意）
- 生成対象（例）:
  - 即日: 命日（0日）
  - 7/14/21/28/35/42/49日（初七日〜七七日=四十九日）、100日（百か日）
  - 年次: 一周忌（1年）、三回忌（2年）、七回忌（6年）、十三回忌（12年）、十七回忌（16年）、二十三回忌（22年）、二十七回忌（26年）、三十三回忌（32年・忌い上げ）、三十七回忌（36年）、五十回忌（49年）
- 出力: 各マイルストーンを個別イベントとして生成・登録
- 表記例:
  - タイトル: `{{houyou}}（祖父）🕊️` → 「四十九日忌（祖父）🕊️」
  - 備考: 四十九日（忌明け）

### 6.6 隔週スケジューリング（祝日除外）（NEW）
- 入力:
  - 期間（開始日/終了日）
  - 曜日（例: 月）
  - 時間帯（開始/終了）
  - カレンダーID、タイトル、祝日除外フラグ
- 仕様:
  - 2週間間隔（INTERVAL=2）で該当曜日にイベント生成
  - 祝日除外が有効な場合、日本の祝日カレンダー `ja.japanese#holiday@group.v.calendar.google.com` を参照して該当日をスキップ
  - 必要に応じて単発登録 or RRULE（FREQ=WEEKLY;INTERVAL=2）で表現

## 7. 非機能要件
- パフォーマンス: 小規模（数百〜数千イベント）で実用的な登録時間
- 可用性: 認証・APIエラー時の明瞭なユーザー通知
- セキュリティ:
  - NextAuth セッション/トークン管理
  - サービスアカウント秘密鍵の安全な管理（環境変数保管）
  - 許可ユーザー制限フラグの確実な適用
- ログ: 主要イベント（認可可否、生成/登録、停止、エラー）をサーバーログへ

## 8. 外部連携
- Google Calendar API（イベント作成）
- Google Sheets API（許可ユーザー取得）
// NEW
- Google Public Holidays（日本の祝日カレンダー参照）

## 9. 環境変数
- `NEXTAUTH_SECRET`
- `GOOGLE_CLIENT_ID`, `GOOGLE_CLIENT_SECRET`
- `IS_ALLOWED_GOOGLE_AUTH_ENABLED`（機能トグル）
- `ALLOWED_USERS_SPREADSHEET_ID`, `ALLOWED_USERS_RANGE`（既定: `Sheet1!A:A`）
- `GOOGLE_SERVICE_ACCOUNT_KEY`（JSON 文字列）
// NEW（任意）
- `JAPANESE_HOLIDAY_CALENDAR_ID`（既定: `ja.japanese#holiday@group.v.calendar.google.com`）

## 10. 受け入れ基準（例）
- [認証] フラグ ON 時、許可リスト外ユーザーはログイン不可になる
- [認証] フラグ OFF 時、Google サインイン成功者はログイン可能になる
- [生成] 10年分を指定すると約120件のイベント候補が生成される
- [登録] 生成されたイベントが指定カレンダーに逐次作成される
- [停止] 停止時点の完了/未処理件数がUIに表示される
- [UI] 記録期間に終了予定日が表示される（例: `10年分 (〜2034/01/01)`）
// NEW: 法要
- [法要] 命日から四十九日・百か日・一周忌・三回忌…五十回忌までが正しい日付で生成される
- [法要] `{{houyou}}` プレースホルダーが法要名に置換される
// NEW: 隔週
- [隔週] 指定期間・曜日・時間帯で2週間間隔のイベントが生成される
- [隔週] 祝日除外が有効な場合、日本の祝日と重なる日は作成されない

## 11. リスクと対応
- Google API クォータ超過: リトライ/待機、一次停止の周知
- 許可リスト取得失敗: フラグ ON 運用時はログイン拒否 → 管理者へアラート/ログ確認
- サービスアカウント権限不足: スプレッドシート共有設定の見直し

## 12. 今後の拡張候補
- 並列登録の安全な最適化（クォータ動的制御）
- テンプレートのカスタム変数/条件式
- 削除/上書きフローのUI提供
- 進捗の永続化/履歴画面

🕊️ 【新機能①】命日から自動で法要を作成
🔹 概要

亡くなった日（命日）を1回入力すると、
初七日、四十九日、一周忌、三回忌、七回忌、十三回忌…五十回忌 までを自動生成して
Googleカレンダーに登録できます。

🔹 対応法要一覧（例）
種別	日数 or 年数	名称	備考
即日	0日	命日	亡くなった日
6日後	7日目	初七日	通常は6日後に行うことも
13日後	二七日	-	
20日後	三七日	-	
27日後	四七日	-	
34日後	五七日（三十五日忌）	-	
41日後	六七日	-	
48日後	七七日（四十九日）	忌明け	
100日後	百か日	-	
1年後	一周忌	満1年	
2年後	三回忌	満2年（1年目を一回忌と数える）	
6年後	七回忌	満6年	
12年後	十三回忌	満12年	
16年後	十七回忌	満16年	
22年後	二十三回忌	満22年	
26年後	二十七回忌	満26年	
32年後	三十三回忌（忌い上げ）	満32年	
36年後	三十七回忌	満36年	
49年後	五十回忌	満49年	
🔹 登録されるカレンダーイベント例
命日（祖父）🕊️
日付: 2025-10-15

初七日忌（祖父）
日付: 2025-10-21

四十九日忌（祖父）【忌明け】
日付: 2025-12-02

一周忌（祖父）
日付: 2026-10-15

三回忌（祖父）
日付: 2027-10-15

...

五十回忌（祖父）
日付: 2074-10-15

🔹 プレースホルダー対応（例）
プレースホルダー	内容	使用例
{{houyou}}	法要名	{{houyou}}（祖父）🕊️ → 「四十九日忌（祖父）🕊️」
{{year}}	命日からの経過年数	{{year}}年目の命日🕯️ → 「3年目の命日🕯️」
{{base_date}}	命日（YYYY-MM-DD）	参考日付表示などに使用
📆 【新機能②】隔週曜日＋時間指定スケジューリング（祝日除外）
🔹 概要

指定した日付から、隔週の特定曜日（例：月曜日）に、
指定した時間帯の予定を自動生成します。
日本の祝日を除外して作成できます 🇯🇵✨

🔹 設定例
開始日: 2025-10-01
終了日: 2025-12-31
曜日: 月曜日
時間: 10:00 - 11:00
カレンダーID: <対象のカレンダー>
タイトル: ミーティング（隔週月曜）
祝日除外: ✅

🔹 結果例（2025年10月〜12月）
日付	曜日	備考
10/06	月	○ 追加
10/13	月	✗ 体育の日（除外）
10/20	月	○ 追加
11/03	月	✗ 文化の日（除外）
11/17	月	○ 追加
12/01	月	○ 追加
12/15	月	○ 追加
🔹 実装上のポイント

Google Calendar APIにイベントをbiweeklyで登録することも可能（RRULE:FREQ=WEEKLY;INTERVAL=2）

ただし祝日除外にはAPIカレンダー（日本の祝日カレンダーID：ja.japanese#holiday@group.v.calendar.google.com）を参照してスキップする必要あり。

🔹 技術的実装イメージ（擬似コード）
const startDate = new Date('2025-10-01');
const endDate = new Date('2025-12-31');
const weekday = 1; // 月曜日
const interval = 2; // 隔週
const time = { start: '10:00', end: '11:00' };

const holidays = await getJapaneseHolidays(startDate, endDate);

for (let d = startDate; d <= endDate; d.setDate(d.getDate() + 1)) {
  if (d.getDay() === weekday && isEveryOtherWeek(d, startDate)) {
    if (!holidays.includes(formatDate(d))) {
      await createEvent(calendarId, d, time, 'ミーティング（隔週月曜）');
    }
  }
}

💡 ガイドへの追記提案（概要文）
🕊️ 命日カレンダー生成機能（NEW）

亡くなった日を入力するだけで、初七日・四十九日・一周忌・三回忌などの法要日程を自動生成し、Googleカレンダーに登録します。
法要名は自動でタイトルに反映され、最大五十回忌まで作成できます。

📆 隔週スケジュール生成機能（NEW）

指定した曜日・時間帯の隔週予定を自動生成。日本の祝日を自動でスキップして作成できるため、会議や定例ミーティングの管理にも便利です。